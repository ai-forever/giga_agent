<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Презентация</title>
    <meta charset="UTF-8">
    <!-- Reveal JS -->
    <!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reset.css">-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
    <style>
        /* Custom styles */
        @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
        }

        h1, h2, h3, h4, h5, h6, p, span, div {
            color: white !important;
        }

        li {
            list-style: none;
        }

        section img {
            width: 100%;
            height: auto;
        }

        .reveal section img {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .reveal section {
            text-align: center;
        }

        @media screen and (max-width: 768px) {
            .reveal h1 {
                font-size: 2em;
            }

            .reveal h2 {
                font-size: 1.5em;
            }

            .reveal p {
                font-size: 1.2em;
            }
        }

        ul, ol {
            color: white;
        }

        .graph {
            margin: auto;
        }

        .graph .main-svg {
            border-radius: 20px;
        }

        .graph {
            max-width: 700px !important;
        }

        .left > .graph, .right > .graph {
            max-width: 500px !important;
        }

        .left > .content, .right > .content {
            max-width: 100% !important;
        }

        .horizontal-slide {
            display: flex;
            align-items: center
        }

        .horizontal-slide > .left {
            flex: 1;
            text-align: left;
            padding-right: 40px;
            overflow-y: auto
        }


        .horizontal-slide > .right {
            flex: 1;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            max-width: 500px;
        }

        .img {
            border-radius: 20px;
            max-width: 400px !important;
        }

        img.graph {
            max-width: 500px !important;
            border-radius: 20px;
        }

        /* Print button */
        .print-button {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.6);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .print-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        @media print {
            .print-button { display: none !important; }
        }
    </style>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <SECTIONS></SECTIONS>
    </div>
</div>

<!-- Floating print button -->
<button class="print-button" title="Экспорт в PDF">Печать</button>

<!-- Reveal JS Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/plugin/math/math.min.js"></script>
<script>
    // Replace placeholders for graphs/images
    jQuery('.graph').each((index, el) => {
        const src = el.getAttribute('src') ? el.getAttribute('src') : el.getAttribute('data-src');
        if (src.startsWith("graph:")) {
            const graphId = src.replace(/^graph:/, "");
            const uuid = crypto.randomUUID();
            fetch(`/graph/store/items?namespace=attachments&key=${graphId}`).then((res) => {
                res.json().then((json) => {
                    if (json.value.type === "image/png") {
                        const d = document.createElement('img');
                        d.attributes = el.attributes;
                        const attributes = $(el).prop("attributes");
                        $.each(attributes, function () {
                            $(d).attr(this.name, this.value);
                        });
                        d.src = `data:image/png;base64, ${json.value.data}`
                        d.setAttribute('id', uuid);
                        d.removeAttribute("data-src");
                        el.parentNode.replaceChild(d, el);
                    } else if (json.value.type === "application/vnd.plotly.v1+json") {
                        const d = document.createElement('div');
                        d.innerHTML = el.innerHTML;
                        d.attributes = el.attributes;
                        const attributes = $(el).prop("attributes");

                        $.each(attributes, function () {
                            $(d).attr(this.name, this.value);
                        });

                        el.parentNode.replaceChild(d, el);
                        el = d;
                        el.setAttribute('id', uuid);
                        const data = json.value.data;
                        Plotly.newPlot(uuid, data.data, data.layout, data.config);

                    }
                });
            });
        }
    });
    // Print/PDF helpers
    const urlParams = new URLSearchParams(window.location.search);
    const isPrintPdf = urlParams.has('print-pdf') || /print-pdf/gi.test(window.location.search);

    // Inject Reveal's PDF print stylesheet when in print mode
    if (isPrintPdf) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/reveal.js@4/dist/print/pdf.css';
        document.head.appendChild(link);
    }

    // Handle print button click: open a new tab with print params
    const printBtn = document.querySelector('.print-button');
    if (printBtn) {
        printBtn.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.searchParams.set('print-pdf', '1');
            url.searchParams.set('autoprint', '1');
            window.open(url.toString(), '_blank');
        });
    }

    setTimeout(() => {
        // Initialize RevealJS
        Reveal.initialize({
            hash: true,
            controls: !isPrintPdf,
            progress: !isPrintPdf,
            history: true,
            keyboard: true,
            overview: true,
            touch: true,
            fragments: true,
            embedded: false,
            help: true,
            pause: true,
            countdown: false,
            transition: 'slide',
            backgroundTransition: 'fade',
            dependencies: [],
            plugins: [RevealMath.KaTeX]
        });

        // Auto-open print dialog when in print mode
        if (isPrintPdf) {
            // Allow disabling via ?autoprint=0 or ?noautoprint
            const shouldAuto = !(
                urlParams.get('autoprint') === '0' || urlParams.has('noautoprint')
            );

            // Close tab when user finishes or cancels printing
            let printStarted = false;
            const safeClose = () => {
                try { window.close(); } catch (e) { /* noop */ }
            };

            window.addEventListener('beforeprint', () => { printStarted = true; });
            window.addEventListener('afterprint', () => { safeClose(); });

            const mediaQuery = window.matchMedia && window.matchMedia('print');
            if (mediaQuery) {
                if ('addEventListener' in mediaQuery) {
                    mediaQuery.addEventListener('change', (e) => {
                        if (!e.matches && printStarted) safeClose();
                    });
                } else if ('addListener' in mediaQuery) {
                    mediaQuery.addListener((e) => {
                        if (!e.matches && printStarted) safeClose();
                    });
                }
            }

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && printStarted) {
                    safeClose();
                }
            });

            Reveal.on('ready', () => {
                setTimeout(() => { if (shouldAuto) window.print(); }, 500);
            });
        }
    }, 200);
</script>
</body>
</html>